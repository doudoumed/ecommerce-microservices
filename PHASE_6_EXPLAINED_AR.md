# شرح المرحلة 6: حزمة المراقبة (Observability Stack)

هذا الملف يشرح التغييرات التي تمت في المرحلة السادسة لإضافة إمكانيات المراقبة والتتبع للنظام.

## 1. الهدف من هذه المرحلة
الهدف هو تحويل النظام من "صندوق أسود" إلى نظام شفاف يمكن مراقبته بسهولة. قمنا بإضافة:
*   **سجلات منظمة (Structured Logging):** تحويل السجلات النصية إلى JSON.
*   **تتبع موزع (Distributed Tracing):** تتبع رحلة الطلب عبر الخدمات المختلفة باستخدام `Correlation ID`.
*   **تجميع السجلات (Centralized Logging):** استخدام ELK Stack لتجميع السجلات في مكان واحد.
*   **مراقبة الأداء (Monitoring):** استخدام Prometheus و Grafana لمراقبة صحة النظام.

---

## 2. تفاصيل التنفيذ

### أ. السجلات المنظمة (Structured Logging)
بدلاً من استخدام `print()` العادية، قمنا باستخدام مكتبة `python-json-logger`.
*   **لماذا؟** لكي تتمكن الأدوات الآلية (مثل Logstash) من قراءة السجلات وفهم الحقول بداخلها (مثل الوقت، المستوى، الرسالة).
*   **التغيير في الكود:**
    ```python
    # في كل ملف app.py
    formatter = jsonlogger.JsonFormatter('%(asctime)s %(level)s %(name)s %(message)s')
    # النتيجة: سجلات بصيغة JSON
    # {"asctime": "...", "level": "INFO", "message": "..."}
    ```

### ب. معرف الارتباط (Correlation ID)
هو معرف فريد (UUID) يتم إنشاؤه عند بوابة API (API Gateway) ويمرر إلى جميع الخدمات الأخرى.
*   **الفائدة:** يمكنك البحث بهذا المعرف في Kibana لرؤية كل السجلات المتعلقة بطلب مستخدم واحد عبر جميع الخدمات.
*   **كيف يعمل؟**
    1.  `api-gateway`: ينشئ `X-Correlation-ID` إذا لم يكن موجوداً.
    2.  الخدمات الأخرى: تستخرج هذا المعرف وتضيفه إلى سجلاتها وإلى أي طلبات ترسلها لخدمات أخرى.

### ج. مكدس ELK (Elasticsearch, Logstash, Kibana)
تمت إضافته في `docker-compose.yml`:
1.  **Logstash:** يستقبل السجلات من الخدمات عبر TCP (المنفذ 5000).
2.  **Elasticsearch:** يخزن السجلات ويفهرسها للبحث السريع.
3.  **Kibana:** واجهة رسومية للبحث في السجلات وعرضها.

### د. المراقبة (Prometheus & Grafana)
1.  **Prometheus:** يقوم بزيارة رابط `/metrics` في كل خدمة كل 15 ثانية لجمع الإحصائيات (مثل عدد الطلبات، وقت الاستجابة).
2.  **Grafana:** يعرض هذه البيانات في لوحات تحكم (Dashboards) رسومية جميلة.
    *   تم تغيير منفذ Prometheus إلى `9091` لتجنب التعارض.

---

## 3. كيفية التشغيل والاختبار

### التشغيل
```bash
sudo docker compose up --build -d
```

### الوصول للأدوات
*   **Kibana (للسجلات):** [http://localhost:5601](http://localhost:5601)
    *   يجب إنشاء Index Pattern باسم `microservices-logs-*`.
*   **Prometheus (للمقاييس الخام):** [http://localhost:9091](http://localhost:9091)
*   **Grafana (للوحات التحكم):** [http://localhost:3000](http://localhost:3000)
    *   اسم المستخدم/كلمة المرور: `admin` / `admin`.

### اختبار التتبع
1.  قم بتسجيل الدخول وإنشاء طلب جديد.
2.  انسخ `correlation_id` من استجابة السجل في التيرمينال.
3.  اذهب إلى Kibana وابحث بهذا المعرف: `correlation_id: "YOUR-UUID"`
4.  ستظهر لك جميع الخطوات التي مر بها طلبك.
